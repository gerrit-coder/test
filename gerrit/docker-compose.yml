version: '3.8'

services:
  gerrit-init:
    image: busybox
    container_name: gerrit-init
    volumes:
      - gerrit_site:/var/gerrit/review_site
    command: sh -c "mkdir -p /var/gerrit/review_site/etc && touch /var/gerrit/review_site/etc/.keep"
    restart: "no"

  gerrit:
    build:
      context: .
      dockerfile: Dockerfile
    image: gerrit:3.4.1
    container_name: gerrit
    hostname: gerrit
    depends_on:
      - gerrit-init
    ports:
      - "8080:8080"   # HTTP
      - "29418:29418" # SSH
    volumes:
      - gerrit_site:/var/gerrit/review_site
      - gerrit_cache:/var/gerrit/cache
      - type: bind
        source: ./etc/gerrit.config
        target: /var/gerrit/review_site/etc/gerrit.config
    environment:
      - GERRIT_SITE=/var/gerrit/review_site
      - JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
    restart: unless-stopped
    networks:
      - gerrit-network

volumes:
  gerrit_site:
    driver: local
  gerrit_cache:
    driver: local

networks:
  gerrit-network:
    driver: bridge
